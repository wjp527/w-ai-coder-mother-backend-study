# ä»£ç æ”¹åŠ¨æ€»ç»“

## å¯¹æ¯”ä¿¡æ¯

- **å¯¹æ¯” Commit**: `9e4d4d8681cf245658f0135eeb461e55e7f7aeea`
- **å½“å‰çŠ¶æ€**: å·¥ä½œåŒºæœªæäº¤çš„æ”¹åŠ¨
- **æ”¹åŠ¨ç»Ÿè®¡**: 10 ä¸ªæ–‡ä»¶ä¿®æ”¹ï¼Œ6 ä¸ªæ–°æ–‡ä»¶ï¼Œæ–°å¢ 193 è¡Œï¼Œåˆ é™¤ 43 è¡Œ

---

## ä¸€ã€æ–°å¢åŠŸèƒ½

### 1.1 å®Œæ•´å¯¹è¯å†å²å­˜å‚¨åŠŸèƒ½ï¼ˆChatHistoryOriginalï¼‰

#### èƒŒæ™¯

è§£å†³ Redis ç¼“å­˜è¿‡æœŸåï¼Œç”¨æˆ·å†æ¬¡å¯¹è¯æ—¶æ— æ³•æ¢å¤å®Œæ•´å¯¹è¯ä¸Šä¸‹æ–‡çš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åŒ…å«å·¥å…·è°ƒç”¨ä¿¡æ¯çš„å¯¹è¯ã€‚

#### æ–°å¢æ–‡ä»¶

1. **å®ä½“ç±»**: `ChatHistoryOriginal.java`

   - å­˜å‚¨å®Œæ•´çš„å¯¹è¯å†å²ï¼ŒåŒ…æ‹¬å·¥å…·è°ƒç”¨è¯·æ±‚å’Œç»“æœ
   - æ”¯æŒ 4 ç§æ¶ˆæ¯ç±»å‹ï¼šuserã€aiã€tool_execution_requestã€tool_execution_result

2. **æœåŠ¡å±‚**:

   - `ChatHistoryOriginalService.java` (æ¥å£)
   - `ChatHistoryOriginalServiceImpl.java` (å®ç°)
   - æä¾›åŠ è½½ã€ä¿å­˜ã€åˆ é™¤ç­‰å®Œæ•´å¯¹è¯å†å²çš„æ–¹æ³•

3. **æ•°æ®è®¿é—®å±‚**:

   - `ChatHistoryOriginalMapper.java` (æ¥å£)
   - `ChatHistoryOriginalMapper.xml` (MyBatis æ˜ å°„æ–‡ä»¶)

4. **æ§åˆ¶å™¨**: `ChatHistoryOriginalController.java`
   - æä¾› RESTful API æ¥å£

#### æ•°æ®åº“å˜æ›´

- **æ–°å¢è¡¨**: `chat_history_original`
  - ç”¨äºå­˜å‚¨åŒ…å«å·¥å…·è°ƒç”¨ä¿¡æ¯çš„å®Œæ•´å¯¹è¯å†å²
  - å­—æ®µåŒ…æ‹¬ï¼šid, message, messageType, appId, userId, createTime, updateTime, isDelete
  - ç´¢å¼•ï¼šidx_appId, idx_createTime, idx_appId_createTime

---

## äºŒã€æ ¸å¿ƒåŠŸèƒ½ä¿®æ”¹

### 2.1 å¯¹è¯è®°å¿†åŠ è½½æœºåˆ¶ä¼˜åŒ–

#### æ–‡ä»¶: `ChatHistoryServiceImpl.java`

#### èƒŒæ™¯é—®é¢˜

åœ¨åŠ è½½å†å²å¯¹è¯è®°å½•æ—¶ï¼Œå¦‚æœ Redis ç¼“å­˜ä¸­æˆ–æ•°æ®åº“ä¸­å­˜åœ¨**æ— æ•ˆçš„ AI æ¶ˆæ¯**ï¼ˆä¾‹å¦‚åªæœ‰ç©ºçš„ `function_call` å­—æ®µï¼Œæ²¡æœ‰ `content` ä¹Ÿæ²¡æœ‰æœ‰æ•ˆçš„ `tool_calls`ï¼‰ï¼Œå½“è¿™äº›æ¶ˆæ¯è¢«åŠ è½½åˆ°å¯¹è¯è®°å¿†ä¸­å¹¶å‘é€ç»™ AI æ¨¡å‹æ—¶ï¼Œä¼šå¯¼è‡´ API æŠ¥é”™ï¼š

```
Invalid assistant message: content or tool_calls must be set
```

**é—®é¢˜åœºæ™¯**ï¼š

- ç”¨æˆ·è¿›è¡Œå¯¹è¯ï¼ŒAI è°ƒç”¨äº†å·¥å…·
- åœ¨ä¿å­˜æˆ–åºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå·¥å…·è°ƒç”¨ä¿¡æ¯ä¸¢å¤±æˆ–æŸå
- å¯¼è‡´æ•°æ®åº“ä¸­å­˜å‚¨çš„ AI æ¶ˆæ¯åªæœ‰ç©ºçš„ `function_call: {}`
- ä¸‹æ¬¡åŠ è½½å†å²è®°å½•æ—¶ï¼Œè¿™ä¸ªæ— æ•ˆæ¶ˆæ¯è¢«åŠ è½½
- å‘é€ç»™ AI æ¨¡å‹æ—¶ï¼Œæ¨¡å‹æ— æ³•è§£æï¼ŒæŠ›å‡ºå¼‚å¸¸

#### è§£å†³æ–¹æ¡ˆ

**ä¸»è¦æ”¹åŠ¨**:

1. **å¢å¼ºæ¶ˆæ¯éªŒè¯æœºåˆ¶**

   - **ç©ºæ¶ˆæ¯æ£€æŸ¥**ï¼šè·³è¿‡å†…å®¹ä¸ºç©ºçš„ç”¨æˆ·æ¶ˆæ¯å’Œ AI æ¶ˆæ¯ï¼Œé¿å…åŠ è½½æ— æ•ˆæ•°æ®
   - **AI æ¶ˆæ¯æœ‰æ•ˆæ€§éªŒè¯**ï¼šæ£€æŸ¥ AI æ¶ˆæ¯æ˜¯å¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š
     - æœ‰ `tool_calls` ä½† `text` ä¸ºç©º
     - `tool_calls` åˆ—è¡¨æœ¬èº«ä¹Ÿä¸ºç©ºæˆ– null
   - **è¿‡æ»¤æ— æ•ˆæ¶ˆæ¯**ï¼šå¦‚æœæ£€æµ‹åˆ°åªæœ‰ç©ºçš„ `tool_calls` çš„æ— æ•ˆæ¶ˆæ¯ï¼Œç›´æ¥è·³è¿‡ï¼Œä¸åŠ è½½åˆ°å¯¹è¯è®°å¿†ä¸­
   - **é˜²æ­¢ API æŠ¥é”™**ï¼šé€šè¿‡æå‰è¿‡æ»¤ï¼Œé¿å…å°†æ— æ•ˆæ¶ˆæ¯å‘é€ç»™ AI æ¨¡å‹

2. **å¼‚å¸¸å¤„ç†å¢å¼º**

   - **ç‹¬ç«‹å¼‚å¸¸å¤„ç†**ï¼šæ¯æ¡æ¶ˆæ¯åŠ è½½ä½¿ç”¨ç‹¬ç«‹çš„ try-catch åŒ…è£¹
   - **å®¹é”™æœºåˆ¶**ï¼šå•æ¡æ¶ˆæ¯åŠ è½½å¤±è´¥ä¸å½±å“æ•´ä½“åŠ è½½æµç¨‹ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€æ¡æ¶ˆæ¯
   - **è¯¦ç»†æ—¥å¿—**ï¼šå¢åŠ è­¦å‘Šæ—¥å¿—ï¼ˆè·³è¿‡æ— æ•ˆæ¶ˆæ¯ï¼‰å’Œé”™è¯¯æ—¥å¿—ï¼ˆåŠ è½½å¤±è´¥ï¼‰ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

3. **ä»£ç æ”¹è¿›è¯¦è§£**

   **ä¹‹å‰çš„ä»£ç **ï¼ˆå­˜åœ¨é—®é¢˜ï¼‰ï¼š

   ```java
   // ç›´æ¥åŠ è½½ï¼Œæ²¡æœ‰ä»»ä½•éªŒè¯
   // å¦‚æœæ¶ˆæ¯æ— æ•ˆï¼Œä¼šå¯¼è‡´åç»­ API è°ƒç”¨å¤±è´¥
   chatMemory.add(AiMessage.from(chatHistory.getMessage()));
   loadedCount++;
   ```

   **é—®é¢˜**ï¼š

   - æ²¡æœ‰éªŒè¯æ¶ˆæ¯å†…å®¹æ˜¯å¦ä¸ºç©º
   - æ²¡æœ‰éªŒè¯ AI æ¶ˆæ¯çš„ `tool_calls` æ˜¯å¦æœ‰æ•ˆ
   - å¦‚æœæ¶ˆæ¯æ— æ•ˆï¼Œä¼šå¯¼è‡´æ•´ä¸ªåŠ è½½æµç¨‹å¤±è´¥æˆ–åç»­ API è°ƒç”¨æŠ¥é”™

   **ç°åœ¨çš„ä»£ç **ï¼ˆå·²ä¼˜åŒ–ï¼‰ï¼š

   ```java
   // 1. é¦–å…ˆæ£€æŸ¥æ¶ˆæ¯å†…å®¹æ˜¯å¦ä¸ºç©º
   String message = chatHistory.getMessage();
   if (StrUtil.isNotBlank(message)) {
       // 2. åˆ›å»º AiMessage å¯¹è±¡
       AiMessage aiMessage = AiMessage.from(message);

       // 3. éªŒè¯ AI æ¶ˆæ¯çš„æœ‰æ•ˆæ€§
       // åœºæ™¯ï¼šAI æ¶ˆæ¯æœ‰ tool_calls ä½† text ä¸ºç©º
       if (aiMessage.hasToolExecutionRequests() &&
           (aiMessage.text() == null || aiMessage.text().trim().isEmpty())) {
           // 4. è¿›ä¸€æ­¥æ£€æŸ¥ï¼šå¦‚æœ tool_calls åˆ—è¡¨ä¹Ÿä¸ºç©ºï¼Œè¯´æ˜è¿™æ˜¯æ— æ•ˆæ¶ˆæ¯
           // åŸå› ï¼šOpenAI API è¦æ±‚ assistant æ¶ˆæ¯å¿…é¡»æœ‰ content æˆ–æœ‰æ•ˆçš„ tool_calls
           // å¦‚æœåªæœ‰ç©ºçš„ tool_callsï¼Œä¼šå¯¼è‡´ API æŠ¥é”™ï¼š
           // "Invalid assistant message: content or tool_calls must be set"
           if (aiMessage.toolExecutionRequests() == null ||
               aiMessage.toolExecutionRequests().isEmpty()) {
               // 5. è·³è¿‡æ— æ•ˆæ¶ˆæ¯ï¼Œè®°å½•è­¦å‘Šæ—¥å¿—
               log.warn("è·³è¿‡æ— æ•ˆçš„ AI æ¶ˆæ¯ï¼ˆåªæœ‰ç©ºçš„ tool_callsï¼‰, appId: {}, chatHistoryId: {}",
                       appId, chatHistory.getId());
               continue; // ä¸åŠ è½½è¿™æ¡æ¶ˆæ¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€æ¡
           }
       }

       // 6. åªæœ‰é€šè¿‡éªŒè¯çš„æ¶ˆæ¯æ‰ä¼šè¢«åŠ è½½
       chatMemory.add(aiMessage);
       loadedCount++;
   } else {
       // 7. ç©ºæ¶ˆæ¯ä¹Ÿè®°å½•è­¦å‘Šï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
       log.warn("è·³è¿‡ç©ºçš„ AI æ¶ˆæ¯, appId: {}, chatHistoryId: {}", appId, chatHistory.getId());
   }
   ```

   **éªŒè¯é€»è¾‘è¯´æ˜**ï¼š

   - **ä¸ºä»€ä¹ˆéœ€è¦éªŒè¯**ï¼šOpenAI/DeepSeek API è¦æ±‚ assistant æ¶ˆæ¯å¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€ï¼š
     - æœ‰ `content` å­—æ®µï¼ˆæ–‡æœ¬å†…å®¹ï¼‰
     - æœ‰æœ‰æ•ˆçš„ `tool_calls` æ•°ç»„ï¼ˆå·¥å…·è°ƒç”¨åˆ—è¡¨ï¼‰
   - **æ— æ•ˆæ¶ˆæ¯çš„ç‰¹å¾**ï¼š
     - `hasToolExecutionRequests()` è¿”å› `true`ï¼ˆè¡¨ç¤ºæœ‰ tool_calls å­—æ®µï¼‰
     - ä½† `text()` ä¸ºç©ºï¼ˆæ²¡æœ‰æ–‡æœ¬å†…å®¹ï¼‰
     - ä¸” `toolExecutionRequests()` ä¸ºç©ºæˆ– nullï¼ˆtool_calls åˆ—è¡¨ä¸ºç©ºï¼‰
   - **å¤„ç†æ–¹å¼**ï¼šè·³è¿‡è¿™ç±»æ— æ•ˆæ¶ˆæ¯ï¼Œé¿å…å¯¼è‡´åç»­ API è°ƒç”¨å¤±è´¥

   **æ•ˆæœ**ï¼š

   - âœ… é˜²æ­¢æ— æ•ˆæ¶ˆæ¯å¯¼è‡´ API æŠ¥é”™
   - âœ… æé«˜å¯¹è¯è®°å¿†åŠ è½½çš„å¥å£®æ€§
   - âœ… å•æ¡æ¶ˆæ¯å¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹
   - âœ… é€šè¿‡æ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥

---

## ä¸‰ã€AI æœåŠ¡å·¥å‚ä¼˜åŒ–

### 3.1 æ–‡ä»¶: `AiCodeGeneratorServiceFactory.java`

**ä¸»è¦æ”¹åŠ¨**:

1. **å¼•å…¥ ChatHistoryOriginalService**

   - æ–°å¢ä¾èµ–æ³¨å…¥ `ChatHistoryOriginalService`
   - ç”¨äºåŠ è½½åŒ…å«å·¥å…·è°ƒç”¨çš„å®Œæ•´å¯¹è¯å†å²

2. **æŒ‰ä»£ç ç”Ÿæˆç±»å‹å·®å¼‚åŒ–åŠ è½½å†å²**

   - **VUE_PROJECT**: ä½¿ç”¨ `chatHistoryOriginalService.loadOriginalChatHistoryToMemory()` åŠ è½½ 50 æ¡å†å²ï¼ˆåŒ…å«å·¥å…·è°ƒç”¨ï¼‰
   - **HTML/MULTI_FILE**: ä½¿ç”¨ `chatHistoryService.loadChatHistoryToMemory()` åŠ è½½ 20 æ¡å†å²ï¼ˆä»…æ–‡æœ¬ï¼‰

3. **ä»£ç ç»“æ„ä¼˜åŒ–**
   - é‡æ„ switch è¯­å¥ï¼Œä½¿ç”¨ä»£ç å—æé«˜å¯è¯»æ€§
   - æ·»åŠ æ—¥å¿—è®°å½• AI Service åˆ›å»ºè¿‡ç¨‹

---

## å››ã€æµå¼å¤„ç†å¢å¼º

### 4.1 æ–‡ä»¶: `JsonMessageStreamHandler.java`

**ä¸»è¦æ”¹åŠ¨**:

1. **å·¥å…·è°ƒç”¨ä¿¡æ¯æ”¶é›†**

   - æ–°å¢ `aiResponseStringBuilder` ç”¨äºæ”¶é›† AI å“åº”å†…å®¹
   - æ–°å¢ `originalChatHistoryList` ç”¨äºæ‰¹é‡å­˜å‚¨å·¥å…·è°ƒç”¨ä¿¡æ¯

2. **å·¥å…·è°ƒç”¨å¤„ç†æµç¨‹**

   - å¤„ç† `TOOL_REQUEST` æ¶ˆæ¯ï¼Œè®°å½•å·¥å…·è°ƒç”¨è¯·æ±‚
   - å¤„ç† `TOOL_EXECUTED` æ¶ˆæ¯ï¼Œè®°å½•å·¥å…·æ‰§è¡Œç»“æœ
   - æ–°å¢ `processToolExecutionMessage()` æ–¹æ³•å¤„ç†å·¥å…·è°ƒç”¨ç›¸å…³ä¿¡æ¯

3. **æ‰¹é‡å…¥åº“ä¼˜åŒ–**
   - åœ¨æµå®Œæˆæ—¶æ‰¹é‡ä¿å­˜å·¥å…·è°ƒç”¨ä¿¡æ¯åˆ° `chat_history_original` è¡¨
   - åŒæ—¶ä¿å­˜åˆ° `chat_history` è¡¨ï¼ˆå‘åå…¼å®¹ï¼‰

---

### 4.1.1 Reactor Flux æ‰§è¡Œé¡ºåºè¯¦è§£

#### é—®é¢˜ï¼š`.map()` ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿ

**ç­”æ¡ˆ**ï¼š`.map()` æ˜¯åœ¨**æ•°æ®æµä¸­æ¯ä¸ªå…ƒç´ åˆ°è¾¾æ—¶ç«‹å³æ‰§è¡Œ**çš„ï¼Œè€Œä¸æ˜¯åœ¨ `doOnComplete()` ä¹‹åæ‰§è¡Œã€‚

#### æ‰§è¡Œé¡ºåºè¯¦è§£

**Reactor Flux çš„æ‰§è¡Œæµç¨‹**ï¼š

```
1. åˆ›å»º Fluxï¼ˆæƒ°æ€§ï¼Œä¸æ‰§è¡Œï¼‰
   â†“
2. è®¢é˜…ï¼ˆsubscribeï¼‰â†’ å¼€å§‹æ‰§è¡Œ
   â†“
3. æ•°æ®æµå¼€å§‹æµåŠ¨
   â†“
4. æ¯ä¸ªæ•°æ®å—åˆ°è¾¾æ—¶ï¼š
   - ç«‹å³æ‰§è¡Œ .map() â†’ å¤„ç†æ•°æ®
   - ç«‹å³æ‰§è¡Œ .filter() â†’ è¿‡æ»¤æ•°æ®
   - ç«‹å³å‘é€ç»™è®¢é˜…è€…
   â†“
5. æ‰€æœ‰æ•°æ®æµå®Œæˆåï¼š
   - æ‰§è¡Œ .doOnComplete() â†’ å¤„ç†å®Œæˆåçš„é€»è¾‘ï¼ˆå¦‚æ‰¹é‡å…¥åº“ï¼‰
   â†“
6. æµç»“æŸ
```

**å…·ä½“åˆ°ä»£ç **ï¼š

```java
return originFlux
    .map(chunk -> {
        // âœ… è¿™é‡Œåœ¨æ¯ä¸ªæ•°æ®å—åˆ°è¾¾æ—¶ç«‹å³æ‰§è¡Œ
        // ä¸æ˜¯ç­‰æµå®Œæˆåå†æ‰§è¡Œï¼
        return handleJsonMessageChunk(chunk, ...);
    })
    .filter(StrUtil::isNotEmpty)
    .doOnComplete(() -> {
        // âœ… è¿™é‡Œåœ¨æ‰€æœ‰æ•°æ®æµå®Œæˆåæ‰æ‰§è¡Œ
        // ç”¨äºæ‰¹é‡å…¥åº“ç­‰æ”¶å°¾å·¥ä½œ
        chatHistoryOriginalService.addOriginalChatMessageBatch(...);
    });
```

**æ—¶é—´çº¿ç¤ºä¾‹**ï¼š

```
æ—¶é—´ 0ms:  è®¢é˜…å¼€å§‹ï¼Œæ•°æ®æµå¼€å§‹
æ—¶é—´ 10ms: æ•°æ®å—1åˆ°è¾¾ â†’ map æ‰§è¡Œ â†’ å¤„ç†æ•°æ®å—1 â†’ å‘é€ç»™è®¢é˜…è€…
æ—¶é—´ 20ms: æ•°æ®å—2åˆ°è¾¾ â†’ map æ‰§è¡Œ â†’ å¤„ç†æ•°æ®å—2 â†’ å‘é€ç»™è®¢é˜…è€…
æ—¶é—´ 30ms: æ•°æ®å—3åˆ°è¾¾ â†’ map æ‰§è¡Œ â†’ å¤„ç†æ•°æ®å—3 â†’ å‘é€ç»™è®¢é˜…è€…
...
æ—¶é—´ 100ms: æ‰€æœ‰æ•°æ®æµå®Œæˆ
æ—¶é—´ 101ms: doOnComplete æ‰§è¡Œ â†’ æ‰¹é‡å…¥åº“
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡**ï¼š

1. **å®æ—¶å¤„ç†**ï¼š`.map()` ç«‹å³å¤„ç†æ¯ä¸ªæ•°æ®å—ï¼Œå¯ä»¥å®æ—¶è¿”å›ç»™å‰ç«¯
2. **æµå¼å“åº”**ï¼šç”¨æˆ·å¯ä»¥çœ‹åˆ°å®æ—¶çš„ AI å“åº”ï¼Œä¸éœ€è¦ç­‰å¾…å…¨éƒ¨å®Œæˆ
3. **æ‰¹é‡å…¥åº“**ï¼š`.doOnComplete()` åœ¨æ‰€æœ‰æ•°æ®æ”¶é›†å®Œæˆåï¼Œä¸€æ¬¡æ€§æ‰¹é‡å…¥åº“ï¼Œæé«˜æ•ˆç‡

**å…³é”®ç†è§£**ï¼š

- `.map()` = **å®æ—¶å¤„ç†**ï¼Œæ¯ä¸ªæ•°æ®å—åˆ°è¾¾æ—¶ç«‹å³æ‰§è¡Œ
- `.doOnComplete()` = **æ”¶å°¾å·¥ä½œ**ï¼Œæ‰€æœ‰æ•°æ®æµå®Œæˆåæ‰æ‰§è¡Œ
- ä¸¤è€…æ˜¯**ä¸åŒçš„æ‰§è¡Œæ—¶æœº**ï¼Œä¸æ˜¯é¡ºåºæ‰§è¡Œçš„å…³ç³»

**æ•°æ®æ”¶é›†è¿‡ç¨‹**ï¼š

```java
// è¿™äº›å˜é‡åœ¨ map æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«ä¿®æ”¹ï¼ˆæ”¶é›†æ•°æ®ï¼‰
StringBuilder chatHistoryStringBuilder = new StringBuilder();
StringBuilder aiResponseStringBuilder = new StringBuilder();
List<ChatHistoryOriginal> originalChatHistoryList = new ArrayList<>();

// map æ‰§è¡Œæ—¶ï¼šæ”¶é›†æ•°æ®åˆ°ä¸Šé¢çš„å˜é‡ä¸­
.map(chunk -> {
    handleJsonMessageChunk(chunk, chatHistoryStringBuilder, ...);
    // æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šä¿®æ”¹ chatHistoryStringBuilder ç­‰å˜é‡
})

// doOnComplete æ‰§è¡Œæ—¶ï¼šä½¿ç”¨æ”¶é›†åˆ°çš„æ•°æ®è¿›è¡Œæ‰¹é‡å…¥åº“
.doOnComplete(() -> {
    // æ­¤æ—¶ chatHistoryStringBuilder ç­‰å˜é‡å·²ç»æ”¶é›†äº†æ‰€æœ‰æ•°æ®
    chatHistoryOriginalService.addOriginalChatMessageBatch(originalChatHistoryList);
})
```

---

### 4.1.2 TOOL_REQUEST å¤„ç†é€»è¾‘è¯¦è§£

#### é—®é¢˜ï¼šä¸ºä»€ä¹ˆ TOOL_REQUEST è¦æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Ÿ

**ç­”æ¡ˆ**ï¼šä¸ºäº†é¿å…é‡å¤æ˜¾ç¤ºåŒä¸€ä¸ªå·¥å…·è°ƒç”¨è¯·æ±‚ã€‚åœ¨æµå¼å“åº”ä¸­ï¼ŒåŒä¸€ä¸ªå·¥å…·è°ƒç”¨å¯èƒ½ä¼šè¢«å¤šæ¬¡å‘é€ï¼Œä½†æˆ‘ä»¬åªæƒ³æ˜¾ç¤ºä¸€æ¬¡ç»™ç”¨æˆ·ã€‚

#### è¯¦ç»†é€»è¾‘è¯´æ˜

**ä»£ç é€»è¾‘**ï¼š

```java
case TOOL_REQUEST -> {
    ToolRequestMessage toolRequestMessage = JSONUtil.toBean(chunk, ToolRequestMessage.class);
    String toolId = toolRequestMessage.getId();
    String toolName = toolRequestMessage.getName();

    // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™ä¸ªå·¥å…· ID
    if (toolId != null && !seenToolIds.contains(toolId)) {
        // ç¬¬ä¸€æ¬¡è°ƒç”¨è¿™ä¸ªå·¥å…·
        seenToolIds.add(toolId);  // è®°å½•è¿™ä¸ª IDï¼Œé¿å…é‡å¤å¤„ç†
        BaseTool tool = toolManager.getToolByName(toolName);
        String result = tool.generateToolRequestResponse();  // ç”Ÿæˆæ ¼å¼åŒ–çš„å·¥å…·è°ƒç”¨ä¿¡æ¯
        return result;  // è¿”å›ç»™å‰ç«¯æ˜¾ç¤º
    } else {
        // ä¸æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨è¿™ä¸ªå·¥å…·ï¼Œç›´æ¥è¿”å›ç©º
        return "";  // ä¸æ˜¾ç¤ºï¼Œé¿å…é‡å¤
    }
}
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªé€»è¾‘**ï¼š

1. **æµå¼ä¼ è¾“çš„ç‰¹æ€§**ï¼š

   - åœ¨æµå¼å“åº”ä¸­ï¼ŒåŒä¸€ä¸ªå·¥å…·è°ƒç”¨å¯èƒ½ä¼šè¢«**å¤šæ¬¡å‘é€**
   - ä¾‹å¦‚ï¼šå·¥å…·è°ƒç”¨çš„å‚æ•°å¯èƒ½åˆ†å¤šæ¬¡ä¼ è¾“ï¼ˆæµå¼ä¼ è¾“ï¼‰
   - æˆ–è€…ï¼šç³»ç»Ÿå¯èƒ½ä¼šé‡è¯•å‘é€åŒä¸€ä¸ªå·¥å…·è°ƒç”¨è¯·æ±‚

2. **ç”¨æˆ·ä½“éªŒé—®é¢˜**ï¼š

   - å¦‚æœæ¯æ¬¡éƒ½æ˜¾ç¤ºï¼Œç”¨æˆ·ä¼šçœ‹åˆ°é‡å¤çš„å·¥å…·è°ƒç”¨ä¿¡æ¯
   - ä¾‹å¦‚ï¼š
     ```
     ç¬¬ä¸€æ¬¡ï¼šè°ƒç”¨ writeFile å·¥å…·ï¼Œå‚æ•°ï¼š{file: "a.js"}
     ç¬¬äºŒæ¬¡ï¼šè°ƒç”¨ writeFile å·¥å…·ï¼Œå‚æ•°ï¼š{file: "a.js"}  â† é‡å¤ï¼
     ç¬¬ä¸‰æ¬¡ï¼šè°ƒç”¨ writeFile å·¥å…·ï¼Œå‚æ•°ï¼š{file: "a.js"}  â† é‡å¤ï¼
     ```
   - ç”¨æˆ·ä¼šå›°æƒ‘ï¼šä¸ºä»€ä¹ˆåŒä¸€ä¸ªå·¥å…·è°ƒç”¨æ˜¾ç¤ºäº†å¤šæ¬¡ï¼Ÿ

3. **è§£å†³æ–¹æ¡ˆ**ï¼š
   - ä½¿ç”¨ `Set<String> seenToolIds` è·Ÿè¸ªå·²ç»è§è¿‡çš„å·¥å…· ID
   - ç¬¬ä¸€æ¬¡çœ‹åˆ°æŸä¸ªå·¥å…· ID æ—¶ï¼šæ˜¾ç¤ºå·¥å…·è°ƒç”¨ä¿¡æ¯ï¼Œå¹¶è®°å½• ID
   - åç»­å†çœ‹åˆ°ç›¸åŒçš„å·¥å…· ID æ—¶ï¼šè¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œä¸æ˜¾ç¤º

**æ‰§è¡Œæµç¨‹ç¤ºä¾‹**ï¼š

```
æ—¶é—´ 10ms: æ”¶åˆ° TOOL_REQUESTï¼ŒtoolId = "call_123"
  â†’ seenToolIds ä¸­æ²¡æœ‰ "call_123"
  â†’ æ·»åŠ åˆ° seenToolIds
  â†’ è¿”å›æ ¼å¼åŒ–çš„å·¥å…·è°ƒç”¨ä¿¡æ¯ï¼š"æ­£åœ¨è°ƒç”¨ writeFile å·¥å…·..."

æ—¶é—´ 20ms: æ”¶åˆ° TOOL_REQUESTï¼ŒtoolId = "call_123"ï¼ˆé‡å¤ï¼‰
  â†’ seenToolIds ä¸­å·²æœ‰ "call_123"
  â†’ è¿”å›ç©ºå­—ç¬¦ä¸² ""ï¼ˆä¸æ˜¾ç¤ºï¼‰

æ—¶é—´ 30ms: æ”¶åˆ° TOOL_REQUESTï¼ŒtoolId = "call_456"ï¼ˆæ–°çš„å·¥å…·è°ƒç”¨ï¼‰
  â†’ seenToolIds ä¸­æ²¡æœ‰ "call_456"
  â†’ æ·»åŠ åˆ° seenToolIds
  â†’ è¿”å›æ ¼å¼åŒ–çš„å·¥å…·è°ƒç”¨ä¿¡æ¯ï¼š"æ­£åœ¨è°ƒç”¨ readFile å·¥å…·..."
```

**å…³é”®ç†è§£**ï¼š

- **`seenToolIds`**ï¼šç”¨äºè·Ÿè¸ªå·²ç»å¤„ç†è¿‡çš„å·¥å…· IDï¼Œé¿å…é‡å¤æ˜¾ç¤º
- **ç¬¬ä¸€æ¬¡è°ƒç”¨**ï¼šæ˜¾ç¤ºå·¥å…·è°ƒç”¨ä¿¡æ¯ï¼Œè®©ç”¨æˆ·çŸ¥é“ AI æ­£åœ¨è°ƒç”¨å·¥å…·
- **åç»­è°ƒç”¨**ï¼šè¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œé¿å…é‡å¤æ˜¾ç¤ºï¼Œä¿æŒç•Œé¢ç®€æ´

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡**ï¼š

1. **é¿å…é‡å¤æ˜¾ç¤º**ï¼šåŒä¸€ä¸ªå·¥å…·è°ƒç”¨åªæ˜¾ç¤ºä¸€æ¬¡ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
2. **ä¿æŒç•Œé¢ç®€æ´**ï¼šä¸ä¼šå› ä¸ºé‡å¤çš„å·¥å…·è°ƒç”¨ä¿¡æ¯è€Œè®©ç•Œé¢æ··ä¹±
3. **å®æ—¶åé¦ˆ**ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ç«‹å³æ˜¾ç¤ºï¼Œè®©ç”¨æˆ·çŸ¥é“ AI æ­£åœ¨åšä»€ä¹ˆ

---

### 4.2 è¾¹ç¼˜è®°å½•æ£€æŸ¥æœºåˆ¶è¯¦è§£

#### æ–‡ä»¶: `ChatHistoryOriginalServiceImpl.java` - `queryHistoryWithEdgeCheck()` æ–¹æ³•

> ğŸ’¡ **ç”¨æœ€ç®€å•çš„è¯ç†è§£**ï¼š
>
> **ä¸ºä»€ä¹ˆæ˜¯å€’åºæŸ¥è¯¢ï¼ˆä»æ–°åˆ°æ—§ï¼‰**ï¼š
>
> 1. **ä¸šåŠ¡éœ€æ±‚**ï¼šæˆ‘ä»¬éœ€è¦åŠ è½½**æœ€è¿‘çš„å¯¹è¯å†å²**ï¼Œè€Œä¸æ˜¯æœ€è€çš„
>
>    - ç”¨æˆ·æœ€è¿‘çš„å¯¹è¯æ›´é‡è¦ï¼Œéœ€è¦ä¼˜å…ˆåŠ è½½
>    - å°±åƒçœ‹èŠå¤©è®°å½•ï¼Œä½ æ€»æ˜¯ä»æœ€æ–°çš„å¼€å§‹çœ‹
>
> 2. **æŠ€æœ¯åŸå› **ï¼šä½¿ç”¨ ID å€’åºå¯ä»¥ä¿è¯ä¸¥æ ¼é¡ºåº
>    - é›ªèŠ±ç®—æ³•ç”Ÿæˆçš„ ID æ˜¯ä¸¥æ ¼é€’å¢çš„ï¼ˆæ–°è®°å½• ID æ›´å¤§ï¼‰
>    - æŒ‰ ID å€’åºæŸ¥è¯¢ï¼Œå¯ä»¥ä¿è¯æ¶ˆæ¯çš„ä¸¥æ ¼é¡ºåº
>    - æ¯”æ—¶é—´æˆ³æ›´å¯é ï¼ˆåŒä¸€ç§’å†…çš„å¤šæ¡æ¶ˆæ¯ï¼Œæ—¶é—´æˆ³å¯èƒ½ç›¸åŒï¼‰
>
> **ä½†æ˜¯ï¼å€’åºæŸ¥è¯¢å¸¦æ¥äº†é—®é¢˜**ï¼š
>
> - **æ­£å¸¸é¡ºåº**ï¼šå…ˆè¯·æ±‚ï¼ˆtool_requestï¼‰â†’ åç»“æœï¼ˆtool_resultï¼‰
> - **å€’åºæŸ¥è¯¢**ï¼šå…ˆç»“æœï¼ˆtool_resultï¼‰â†’ åè¯·æ±‚ï¼ˆtool_requestï¼‰
>
> **å°±åƒ**ï¼šä½ å…ˆçœ‹åˆ°äº†ç­”æ¡ˆï¼Œåçœ‹åˆ°äº†é¢˜ç›®ï¼Œé¡ºåºå®Œå…¨åäº†ï¼
>
> **åæœ**ï¼šAI çœ‹åˆ°è¿™ä¸ªååºä¼šæŠ¥é”™ï¼Œæ— æ³•ç†è§£ã€‚
>
> **è§£å†³**ï¼šæ£€æŸ¥è¾¹ç•Œè®°å½•ï¼Œå¦‚æœå‘ç°é¡ºåºé—®é¢˜ï¼Œå°±ç¼©å°æŸ¥è¯¢èŒƒå›´ï¼Œé¿å…åŠ è½½ååºçš„æ•°æ®ã€‚

#### èƒŒæ™¯é—®é¢˜

**æ ¸å¿ƒé—®é¢˜**ï¼šå·¥å…·è°ƒç”¨ä¿¡æ¯å¿…é¡»æ˜¯æˆå¯¹ä¸”æœ‰åºçš„ `tool_request -> tool_result`ï¼Œå¦åˆ™ä¼šå¯¼è‡´ API æŠ¥é”™ï¼š

```
Messages with role 'tool' must be a response to a preceding message with 'tool_calls'
```

**é—®é¢˜åœºæ™¯**ï¼š

- å½“æŸ¥è¯¢å†å²è®°å½•æ—¶ï¼Œå¦‚æœæŸ¥è¯¢è¾¹ç•Œï¼ˆç¬¬ `maxCount + 1` æ¡è®°å½•ï¼‰æ˜¯ `tool_result` ç±»å‹
- ä½†å¯¹åº”çš„ `tool_request` ä¸åœ¨æŸ¥è¯¢èŒƒå›´å†…ï¼ˆè¢«æˆªæ–­äº†ï¼‰
- åŠ è½½åˆ°å¯¹è¯è®°å¿†åï¼Œ`tool_result` å‰é¢æ²¡æœ‰å¯¹åº”çš„ `tool_request`
- å‘é€ç»™ AI æ¨¡å‹æ—¶ï¼Œæ¨¡å‹æ— æ³•ç†è§£è¿™ä¸ªå­¤ç«‹çš„ `tool_result`ï¼Œå¯¼è‡´æŠ¥é”™

**ç¤ºä¾‹**ï¼š

```
å‡è®¾æ•°æ®åº“ä¸­æœ‰ä»¥ä¸‹è®°å½•ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰ï¼š
1. user: "å¸®æˆ‘ç”Ÿæˆä»£ç "
2. ai: "å¥½çš„ï¼Œæˆ‘æ¥ç”Ÿæˆ"
3. tool_request: "è°ƒç”¨ writeFile å·¥å…·"
4. tool_result: "æ–‡ä»¶å†™å…¥æˆåŠŸ"
5. ai: "ä»£ç å·²ç”Ÿæˆ"
6. user: "ä¿®æ”¹ä¸€ä¸‹"  â† è¿™æ˜¯æœ€æ–°çš„ç”¨æˆ·æ¶ˆæ¯

å¦‚æœ maxCount = 3ï¼ŒæŸ¥è¯¢å‰ 3 æ¡è®°å½•ï¼š
- æŸ¥è¯¢ç»“æœï¼šuser(6), ai(5), tool_result(4)
- é—®é¢˜ï¼štool_result(4) å‰é¢æ²¡æœ‰å¯¹åº”çš„ tool_request(3)
- ç»“æœï¼šAPI æŠ¥é”™ï¼
```

#### è§£å†³æ–¹æ¡ˆè¯¦è§£

**æ–¹æ³•æ ¸å¿ƒé€»è¾‘**ï¼š`queryHistoryWithEdgeCheck()` æ–¹æ³•é€šè¿‡è¾¹ç¼˜æ£€æŸ¥ï¼Œç¡®ä¿å·¥å…·è°ƒç”¨çš„å®Œæ•´æ€§ã€‚

#### è¯¦ç»†æ­¥éª¤è¯´æ˜

**æ­¥éª¤ 1ï¼šæ£€æŸ¥æ€»è®°å½•æ•°**

```java
long totalCount = this.count(countQueryWrapper);
```

- ç»Ÿè®¡è¯¥åº”ç”¨çš„æ‰€æœ‰å¯¹è¯å†å²è®°å½•æ•°

**æ­¥éª¤ 2ï¼šå¤„ç†è®°å½•æ•°ä¸è¶³çš„æƒ…å†µ**

```java
if(totalCount <= 1) {
    return Collections.emptyList();
}
```

- **ä¸ºä»€ä¹ˆè·³è¿‡æ€»è®°å½•æ•° â‰¤ 1**ï¼š
  - å¦‚æœåªæœ‰ 1 æ¡è®°å½•ï¼Œé€šå¸¸æ˜¯ç”¨æˆ·åˆšå‘é€çš„æ¶ˆæ¯ï¼ŒAI è¿˜æ²¡æœ‰å›å¤
  - è¿™ç§ä¸å®Œæ•´çš„å¯¹è¯å¯¹æ¢å¤ä¸Šä¸‹æ–‡æ²¡æœ‰å‚è€ƒä»·å€¼
  - å› æ­¤ç›´æ¥è¿”å›ç©ºåˆ—è¡¨ï¼Œä¸åŠ è½½ä»»ä½•å†å²è®°å½•

**æ­¥éª¤ 3ï¼šè®¡ç®—å¯ç”¨è®°å½•æ•°**

```java
long availableCount = totalCount - 1;
```

- **ä¸ºä»€ä¹ˆå‡å» 1**ï¼š
  - ç¬¬ä¸€æ¡è®°å½•ï¼ˆæœ€æ–°çš„è®°å½•ï¼‰é€šå¸¸æ˜¯ç”¨æˆ·åˆšå‘é€çš„æ¶ˆæ¯
  - è¿™æ¡æ¶ˆæ¯å·²ç»åœ¨å½“å‰å¯¹è¯ä¸­ï¼Œä¸éœ€è¦ä»å†å²è®°å½•ä¸­åŠ è½½
  - å› æ­¤è·³è¿‡ç¬¬ä¸€æ¡ï¼Œä»ç¬¬äºŒæ¡å¼€å§‹æŸ¥è¯¢
  - ä¾‹å¦‚ï¼šæ€»å…± 10 æ¡è®°å½•ï¼Œå¯ç”¨è®°å½• = 10 - 1 = 9 æ¡

**æ­¥éª¤ 4ï¼šå¤„ç†è®°å½•æ•°è¾ƒå°‘çš„æƒ…å†µï¼ˆä¸éœ€è¦è¾¹ç¼˜æ£€æŸ¥ï¼‰**

```java
if(totalCount <= maxCount + 1) {
    // ç›´æ¥æŸ¥è¯¢æ‰€æœ‰å¯ç”¨è®°å½•ï¼ˆè·³è¿‡æœ€æ–°çš„ç”¨æˆ·æ¶ˆæ¯ï¼‰
    QueryWrapper queryWrapper = QueryWrapper.create()
            .eq(ChatHistoryOriginal::getAppId, appId)
            .orderBy(ChatHistoryOriginal::getId, false) // ä½¿ç”¨idå€’åºï¼Œä¿è¯é¡ºåºæ€§
            .limit(1, availableCount); // è·³è¿‡ç”¨æˆ·æœ€æ–°å‘é€çš„æ¶ˆæ¯
    return this.list(queryWrapper);
}
```

- **ä¸ºä»€ä¹ˆä½¿ç”¨å€’åºæŸ¥è¯¢ï¼ˆä»æ–°åˆ°æ—§ï¼‰**ï¼š

  **ä¸šåŠ¡åŸå› **ï¼š

  - æˆ‘ä»¬éœ€è¦åŠ è½½**æœ€è¿‘çš„å¯¹è¯å†å²**ï¼Œè€Œä¸æ˜¯æœ€è€çš„
  - ç”¨æˆ·æœ€è¿‘çš„å¯¹è¯æ›´é‡è¦ï¼Œéœ€è¦ä¼˜å…ˆåŠ è½½
  - å°±åƒçœ‹èŠå¤©è®°å½•ï¼Œä½ æ€»æ˜¯ä»æœ€æ–°çš„å¼€å§‹çœ‹

  **æŠ€æœ¯åŸå› **ï¼š

  - ä½¿ç”¨ ID å€’åºå¯ä»¥ä¿è¯ä¸¥æ ¼é¡ºåº
  - é›ªèŠ±ç®—æ³•ç”Ÿæˆçš„ ID æ˜¯ä¸¥æ ¼é€’å¢çš„ï¼ˆæ–°è®°å½• ID æ›´å¤§ï¼‰
  - æŒ‰ ID å€’åºæŸ¥è¯¢ï¼Œå¯ä»¥ä¿è¯æ¶ˆæ¯çš„ä¸¥æ ¼é¡ºåº
  - æ¯”æ—¶é—´æˆ³æ›´å¯é ï¼ˆåŒä¸€ç§’å†…çš„å¤šæ¡æ¶ˆæ¯ï¼Œæ—¶é—´æˆ³å¯èƒ½ç›¸åŒï¼‰

  **ä¸ºä»€ä¹ˆä¸èƒ½æ”¹æˆæ­£åºæŸ¥è¯¢**ï¼š

  - å¦‚æœæ­£åºæŸ¥è¯¢ï¼ˆä»æ—§åˆ°æ–°ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦æŸ¥è¯¢æœ€è€çš„è®°å½•
  - ä½†æˆ‘ä»¬éœ€è¦çš„æ˜¯**æœ€è¿‘çš„ N æ¡è®°å½•**ï¼Œè€Œä¸æ˜¯æœ€è€çš„ N æ¡
  - æ­£åºæŸ¥è¯¢éœ€è¦å…ˆæŸ¥è¯¢æ€»æ•°ï¼Œå†è®¡ç®—åç§»é‡ï¼Œæ•ˆç‡ä½
  - å€’åºæŸ¥è¯¢å¯ä»¥ç›´æ¥è·å–æœ€æ–°çš„è®°å½•ï¼Œæ•ˆç‡é«˜

- **ä¸ºä»€ä¹ˆä½¿ç”¨ ID å€’åºè€Œä¸æ˜¯æ—¶é—´æˆ³**ï¼š

  - æ—¶é—´æˆ³å¯èƒ½å› ä¸ºç›¸è¿‘å€¼è€Œä¸ç¨³å®šï¼ˆåŒä¸€ç§’å†…çš„å¤šæ¡æ¶ˆæ¯ï¼‰
  - MyBatis-flex çš„é›ªèŠ±ç®—æ³•ç”Ÿæˆçš„ ID æ˜¯ä¸¥æ ¼é€’å¢çš„
  - ä½¿ç”¨ ID å€’åºå¯ä»¥ä¿è¯æ¶ˆæ¯çš„ä¸¥æ ¼é¡ºåºï¼Œé¿å… `tool_request` å’Œ `tool_result` é¡ºåºé”™ä¹±

- **ä¸ºä»€ä¹ˆè¿™é‡Œä¸éœ€è¦è®¾ç½®æœ€å¤šæŸ¥è¯¢æ¡æ•°**ï¼š
  - å½“æ€»è®°å½•æ•° â‰¤ maxCount + 1 æ—¶ï¼Œæ‰€æœ‰å¯ç”¨è®°å½•éƒ½åœ¨æŸ¥è¯¢èŒƒå›´å†…
  - ä¸éœ€è¦é¢å¤–é™åˆ¶ï¼Œç›´æ¥æŸ¥è¯¢æ‰€æœ‰å¯ç”¨è®°å½•å³å¯

**æ­¥éª¤ 5ï¼šæ£€æŸ¥è¾¹ç¼˜è®°å½•ï¼ˆå½“è®°å½•æ•°è¾ƒå¤šæ—¶ï¼‰**

> ğŸ’¡ **ç”¨æœ€ç®€å•çš„æ–¹å¼ç†è§£**ï¼š
>
> æƒ³è±¡ä½ åœ¨çœ‹ä¸€æœ¬ä¹¦ï¼Œä½†ä½ æ˜¯**ä»åå¾€å‰çœ‹**ï¼ˆå€’åºï¼‰ï¼š
>
> - æ­£å¸¸é¡ºåºï¼šå…ˆçœ‹é¢˜ç›®ï¼ˆtool_requestï¼‰ï¼Œå†çœ‹ç­”æ¡ˆï¼ˆtool_resultï¼‰
> - å€’åºçœ‹ï¼šå…ˆçœ‹ç­”æ¡ˆï¼ˆtool_resultï¼‰ï¼Œå†çœ‹é¢˜ç›®ï¼ˆtool_requestï¼‰
> - é—®é¢˜ï¼šé¡ºåºåäº†ï¼ŒAI æ— æ³•ç†è§£ï¼
>
> æ‰€ä»¥éœ€è¦æ£€æŸ¥è¾¹ç•Œï¼Œé¿å…åŠ è½½é¡ºåºé”™è¯¯çš„æ•°æ®ã€‚

```java
// æŸ¥è¯¢ç¬¬ maxCount + 1 æ¡è®°å½•
QueryWrapper edgeQueryWrapper = QueryWrapper.create()
        .eq(ChatHistoryOriginal::getAppId, appId)
        .orderBy(ChatHistoryOriginal::getId, false)
        .limit(maxCount, 1); // è·³è¿‡ maxCount æ¡ï¼ŒæŸ¥è¯¢ 1 æ¡ï¼ˆç¬¬ maxCount + 1 æ¡ï¼‰

ChatHistoryOriginal edgeRecord = this.getOne(edgeQueryWrapper);
```

- **ä¸ºä»€ä¹ˆæŸ¥è¯¢ç¬¬ maxCount + 1 æ¡**ï¼ˆæœ€é€šä¿—çš„è§£é‡Šï¼‰ï¼š

  **æ ¸å¿ƒé—®é¢˜**ï¼šå› ä¸ºæŸ¥è¯¢æ˜¯**å€’åº**çš„ï¼ˆä»æ–°åˆ°æ—§ï¼‰ï¼Œä¼šå¯¼è‡´å·¥å…·è°ƒç”¨çš„é¡ºåºé”™è¯¯ï¼

  **ä¸¾ä¸ªä¾‹å­ï¼Œç”¨ä½ æåˆ°çš„æ­£å¸¸é¡ºåº**ï¼š

  ```
  æ­£å¸¸çš„æ—¶é—´é¡ºåºï¼ˆä»æ—©åˆ°æ™šï¼‰ï¼š
  1. user: "å¸®æˆ‘ç”Ÿæˆä»£ç "
  2. tool_request: "è°ƒç”¨ writeFile å·¥å…·"      â† å…ˆè¯·æ±‚
  3. tool_result: "æ–‡ä»¶å†™å…¥æˆåŠŸ"              â† åç»“æœ
  4. ai: "ä»£ç å·²ç”Ÿæˆ"
  5. user: "ä¿®æ”¹ä¸€ä¸‹"                        â† æœ€æ–°æ¶ˆæ¯
  ```

  **ä½†æ˜¯ï¼æ•°æ®åº“æŸ¥è¯¢æ˜¯å€’åºçš„ï¼ˆä»æ–°åˆ°æ—§ï¼‰**ï¼š

  ```
  æŸ¥è¯¢ç»“æœçš„é¡ºåºï¼ˆä»æ–°åˆ°æ—§ï¼ŒID ä»å¤§åˆ°å°ï¼‰ï¼š
  ç¬¬1æ¡ï¼ˆæœ€æ–°ï¼‰: user: "ä¿®æ”¹ä¸€ä¸‹"           â† ä¼šè¢«è·³è¿‡ï¼ˆå½“å‰å¯¹è¯ï¼‰
  ç¬¬2æ¡: ai: "ä»£ç å·²ç”Ÿæˆ"
  ç¬¬3æ¡: tool_result: "æ–‡ä»¶å†™å…¥æˆåŠŸ"        â† ç»“æœåœ¨è¯·æ±‚å‰é¢ï¼
  ç¬¬4æ¡: tool_request: "è°ƒç”¨ writeFile"    â† è¯·æ±‚åœ¨ç»“æœåé¢ï¼
  ç¬¬5æ¡: user: "å¸®æˆ‘ç”Ÿæˆä»£ç "
  ```

  **å¦‚æœ maxCount = 2ï¼ŒæŸ¥è¯¢ 2 æ¡è®°å½•ï¼ˆè·³è¿‡ç¬¬ 1 æ¡ï¼‰**ï¼š

  ```
  æŸ¥è¯¢ç»“æœï¼š
  - ç¬¬2æ¡: ai
  - ç¬¬3æ¡: tool_result
  - ç¬¬4æ¡: tool_request  â† åœ¨æŸ¥è¯¢èŒƒå›´å†…ï¼Œä½†é¡ºåºæ˜¯åçš„ï¼

  é—®é¢˜ï¼š
  - tool_result åœ¨ tool_request å‰é¢ï¼
  - æ­£ç¡®çš„é¡ºåºåº”è¯¥æ˜¯ï¼štool_request â†’ tool_result
  - è¿™ä¸ªé¡ºåºé”™è¯¯ä¼šå¯¼è‡´ API æŠ¥é”™ï¼
  ```

  **ä¸ºä»€ä¹ˆè¦æ£€æŸ¥ç¬¬ maxCount + 1 æ¡**ï¼š

  - è¿™æ¡è®°å½•æ˜¯**æŸ¥è¯¢è¾¹ç•Œä¹‹å¤–çš„ç¬¬ä¸€æ¡è®°å½•**
  - å¦‚æœè¿™æ¡è®°å½•æ˜¯ `tool_result`ï¼Œè¯´æ˜ï¼š
    - **æƒ…å†µ A**ï¼šæŸ¥è¯¢ç»“æœä¸­å¯èƒ½åŒ…å«äº† `tool_result`ï¼Œä½†å¯¹åº”çš„ `tool_request` åœ¨æŸ¥è¯¢èŒƒå›´ä¹‹å¤–ï¼ˆæ›´æ—©çš„ä½ç½®ï¼‰
    - **æƒ…å†µ B**ï¼šæŸ¥è¯¢ç»“æœä¸­ `tool_result` å’Œ `tool_request` éƒ½åœ¨æŸ¥è¯¢èŒƒå›´å†…ï¼Œä½†é¡ºåºæ˜¯é”™çš„ï¼ˆå› ä¸ºå€’åºï¼‰
  - éœ€è¦é¢å¤–å¤„ç†ï¼Œç¡®ä¿å·¥å…·è°ƒç”¨çš„å®Œæ•´æ€§

  **å›ç­”ä½ çš„å…·ä½“é—®é¢˜**ï¼š

  > å¦‚æœè¾¹ç¼˜è®°å½•æ˜¯ `tool_result`ï¼Œå¯¹åº”çš„ `tool_request` åœ¨æŸ¥è¯¢èŒƒå›´å†…å—ï¼Ÿ

  **ç­”æ¡ˆ**ï¼š

  - **å¯èƒ½åœ¨ï¼Œä¹Ÿå¯èƒ½ä¸åœ¨**ï¼Œä½†è¿™ä¸æ˜¯å…³é”®é—®é¢˜
  - **å…³é”®é—®é¢˜æ˜¯**ï¼šå› ä¸ºå€’åºæŸ¥è¯¢ï¼Œå³ä½¿ä¸¤è€…éƒ½åœ¨æŸ¥è¯¢èŒƒå›´å†…ï¼Œ`tool_result` ä¹Ÿä¼šå‡ºç°åœ¨ `tool_request` å‰é¢
  - è¿™ä¸ªé¡ºåºé”™è¯¯ä¼šå¯¼è‡´ API æŠ¥é”™ï¼Œæ‰€ä»¥éœ€è¦ç‰¹æ®Šå¤„ç†

  **å›ç­”ä½ çš„é—®é¢˜**ï¼š

  - å¦‚æœè¾¹ç¼˜è®°å½•æ˜¯ `tool_result`ï¼Œå¯¹åº”çš„ `tool_request` **å¯èƒ½åœ¨æŸ¥è¯¢èŒƒå›´å†…ï¼Œä¹Ÿå¯èƒ½ä¸åœ¨**
  - ä½†**å…³é”®é—®é¢˜æ˜¯**ï¼šå› ä¸ºå€’åºæŸ¥è¯¢ï¼Œ`tool_result`ï¼ˆæ›´æ–°çš„è®°å½•ï¼‰ä¼šå‡ºç°åœ¨ `tool_request`ï¼ˆæ›´æ—©çš„è®°å½•ï¼‰å‰é¢
  - å³ä½¿ä¸¤è€…éƒ½åœ¨æŸ¥è¯¢èŒƒå›´å†…ï¼Œé¡ºåºä¹Ÿæ˜¯é”™çš„ï¼Œä¼šå¯¼è‡´ API æŠ¥é”™

- **ä¸ºä»€ä¹ˆåªæŸ¥è¯¢ä¸€æ¡æ•°æ®**ï¼š
  - åªéœ€è¦æ£€æŸ¥è¾¹ç•Œè®°å½•çš„ç±»å‹
  - ä¸€æ¡è®°å½•è¶³å¤Ÿåˆ¤æ–­æ˜¯å¦éœ€è¦é¢å¤–å¤„ç†

**æ­¥éª¤ 6ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦é¢å¤–çš„ tool_request**

```java
boolean needExtraRequest = false;
if(edgeRecord != null) {
    String edgeMessageType = edgeRecord.getMessageType();
    ChatHistoryMessageTypeEnum edgeMessageTypeEnum = ChatHistoryMessageTypeEnum.getEnumByValue(edgeMessageType);
    needExtraRequest = (edgeMessageTypeEnum == ChatHistoryMessageTypeEnum.TOOL_EXECUTION_RESULT);
}
```

- **åˆ¤æ–­é€»è¾‘**ï¼š
  - å¦‚æœè¾¹ç¼˜è®°å½•æ˜¯ `TOOL_EXECUTION_RESULT` ç±»å‹
  - è¯´æ˜éœ€è¦ç¡®ä¿å¯¹åº”çš„ `TOOL_EXECUTION_REQUEST` ä¹Ÿåœ¨æŸ¥è¯¢ç»“æœä¸­
  - å¦åˆ™ä¼šå¯¼è‡´å·¥å…·è°ƒç”¨ä¸å®Œæ•´

**æ­¥éª¤ 7ï¼šè®¡ç®—å®é™…æŸ¥è¯¢è®°å½•æ•°**

```java
long actualLimit = Math.min(needExtraRequest ? maxCount + 1 : maxCount, availableCount);
```

- **è®¡ç®—é€»è¾‘è¯¦è§£**ï¼š
  - å¦‚æœ `needExtraRequest = true`ï¼šéœ€è¦æŸ¥è¯¢ `maxCount + 1` æ¡ï¼ˆå¤šæŸ¥ä¸€æ¡ä»¥ç¡®ä¿åŒ…å« tool_requestï¼‰
  - å¦‚æœ `needExtraRequest = false`ï¼šåªéœ€è¦æŸ¥è¯¢ `maxCount` æ¡
  - ä½†å®é™…æŸ¥è¯¢æ•°ä¸èƒ½è¶…è¿‡ `availableCount`ï¼ˆå¯ç”¨è®°å½•æ•°ï¼‰
  - ä½¿ç”¨ `Math.min()` å–æœ€å°å€¼ï¼Œé¿å…æŸ¥è¯¢è¶…å‡ºèŒƒå›´

**æ­¥éª¤ 8ï¼šæ‰§è¡ŒæŸ¥è¯¢**

```java
QueryWrapper queryWrapper = QueryWrapper.create()
        .eq(ChatHistoryOriginal::getAppId, appId)
        .orderBy(ChatHistoryOriginal::getId, false)
        .limit(1, actualLimit); // æŸ¥è¯¢ä»ç¬¬äºŒæ¡å¼€å§‹çš„ actualLimit æ¡è®°å½•

List<ChatHistoryOriginal> originalHistoryList = this.list(queryWrapper);
```

- **æŸ¥è¯¢é€»è¾‘**ï¼š
  - `limit(1, actualLimit)` è¡¨ç¤ºï¼šè·³è¿‡ç¬¬ 1 æ¡ï¼ˆæœ€æ–°çš„ç”¨æˆ·æ¶ˆæ¯ï¼‰ï¼ŒæŸ¥è¯¢æ¥ä¸‹æ¥çš„ `actualLimit` æ¡
  - ä¾‹å¦‚ï¼š`limit(1, 5)` è¡¨ç¤ºè·³è¿‡ç¬¬ 1 æ¡ï¼ŒæŸ¥è¯¢ç¬¬ 2-6 æ¡ï¼ˆå…± 5 æ¡ï¼‰

**æ­¥éª¤ 9ï¼šè°ƒæ•´ maxCountï¼ˆå¦‚æœéœ€è¦ï¼‰**

```java
if(needExtraRequest && originalHistoryList.size() <= maxCount) {
    // è°ƒæ•´ maxCountï¼Œé‡æ–°æŸ¥è¯¢
    maxCount = Math.max(0, maxCount - 1);
    // ... é‡æ–°æŸ¥è¯¢
}
```

- **ä¸ºä»€ä¹ˆéœ€è¦è°ƒæ•´ maxCount**ï¼ˆè¿™æ˜¯æœ€å¤æ‚çš„é€»è¾‘ï¼Œéœ€è¦ä»”ç»†ç†è§£ï¼‰ï¼š

  **æ ¸å¿ƒåŸå› **ï¼š`TOOL_EXECUTION_REQUEST` å¿…é¡»å’Œ `TOOL_EXECUTION_RESULT` æˆå¯¹å‡ºç°ï¼ŒAI æ‰èƒ½ç†è§£å®Œæ•´çš„å·¥å…·è°ƒç”¨æµç¨‹ã€‚

  **è¯¦ç»†åˆ†æ**ï¼š

  1. **é—®é¢˜åœºæ™¯**ï¼š

     - è¾¹ç¼˜è®°å½•ï¼ˆç¬¬ maxCount + 1 æ¡ï¼‰æ˜¯ `tool_result`
     - åœ¨æ­¥éª¤ 7 ä¸­ï¼Œæˆ‘ä»¬å°è¯•æŸ¥è¯¢ `maxCount + 1` æ¡è®°å½•ï¼Œå¸Œæœ›èƒ½åŒ…å«å¯¹åº”çš„ `tool_request`
     - ä½†åœ¨æ­¥éª¤ 8 æŸ¥è¯¢åï¼Œå¦‚æœ `originalHistoryList.size() <= maxCount`ï¼Œè¯´æ˜è™½ç„¶æˆ‘ä»¬æƒ³å¤šæŸ¥ä¸€æ¡ï¼Œä½†å®é™…è¿”å›çš„è®°å½•æ•°å¹¶æ²¡æœ‰è¶…è¿‡ maxCount

  2. **ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µ**ï¼š

     - **æƒ…å†µ A**ï¼š`availableCount < maxCount + 1`ï¼ˆå¯ç”¨è®°å½•æ•°ä¸å¤Ÿï¼‰
       - ä¾‹å¦‚ï¼š`maxCount = 50`ï¼Œä½† `availableCount = 50`
       - è™½ç„¶ `actualLimit = min(51, 50) = 50`ï¼Œä½†æŸ¥è¯¢ç»“æœå¯èƒ½åªæœ‰ 50 æ¡
       - è¿™ 50 æ¡è®°å½•ä¸­ï¼Œæœ€åä¸€æ¡æ˜¯ `tool_result`ï¼Œä½†å¯èƒ½æ²¡æœ‰å¯¹åº”çš„ `tool_request`ï¼ˆå› ä¸ºè¢«æˆªæ–­äº†ï¼‰
     - **æƒ…å†µ B**ï¼šæŸ¥è¯¢ç»“æœä¸­ç¡®å®æ²¡æœ‰åŒ…å«å¯¹åº”çš„ `tool_request`
       - è™½ç„¶æŸ¥è¯¢äº† `maxCount + 1` æ¡ï¼Œä½†æŸ¥è¯¢ç»“æœä¸­æœ€åä¸€æ¡æ˜¯ `tool_result`
       - è¯´æ˜å¯¹åº”çš„ `tool_request` ä¸åœ¨æŸ¥è¯¢èŒƒå›´å†…ï¼ˆåœ¨æ›´æ—©çš„ä½ç½®ï¼‰

  3. **ä¸ºä»€ä¹ˆè¦ç¼©å°æŸ¥è¯¢èŒƒå›´**ï¼š

     - å¦‚æœæŸ¥è¯¢ç»“æœä¸­æœ€åä¸€æ¡æ˜¯ `tool_result`ï¼Œä½†å‰é¢æ²¡æœ‰å¯¹åº”çš„ `tool_request`
     - è¿™ä¸ªå­¤ç«‹çš„ `tool_result` ä¼šå¯¼è‡´ API æŠ¥é”™
     - **è§£å†³æ–¹æ¡ˆ**ï¼šç¼©å°æŸ¥è¯¢èŒƒå›´ï¼ˆmaxCount - 1ï¼‰ï¼Œé‡æ–°æŸ¥è¯¢
     - **ç›®çš„**ï¼šé€šè¿‡ç¼©å°èŒƒå›´ï¼Œç¡®ä¿æŸ¥è¯¢ç»“æœçš„æœ€åä¸€æ¡ä¸æ˜¯å­¤ç«‹çš„ `tool_result`
     - **åŸç†**ï¼šå¦‚æœç¼©å°èŒƒå›´åï¼Œæœ€åä¸€æ¡ä¸å†æ˜¯ `tool_result`ï¼Œæˆ–è€…æŸ¥è¯¢ç»“æœä¸­åŒ…å«äº†å®Œæ•´çš„å·¥å…·è°ƒç”¨å¯¹ï¼Œå°±å¯ä»¥é¿å…æŠ¥é”™

  4. **å…·ä½“ç¤ºä¾‹**ï¼ˆé€šä¿—è§£é‡Šï¼‰ï¼š

     **åœºæ™¯è®¾ç½®**ï¼š

     ```
     æ•°æ®åº“ä¸­çš„è®°å½•ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼Œä»æ–°åˆ°æ—§ï¼ŒID ä»å¤§åˆ°å°ï¼‰ï¼š

     ç¬¬1æ¡ï¼ˆæœ€æ–°ï¼‰: user: "ä¿®æ”¹ä»£ç "           â† ä¼šè¢«è·³è¿‡ï¼ˆå½“å‰å¯¹è¯ï¼‰
     ç¬¬2æ¡: tool_result: "æ–‡ä»¶ä¿®æ”¹æˆåŠŸ"        â† è¿™æ˜¯è¾¹ç¼˜è®°å½•ï¼ˆç¬¬ maxCount + 1 æ¡ï¼‰
     ç¬¬3æ¡: tool_request: "è°ƒç”¨ modifyFile"   â† å¯¹åº”çš„ tool_request
     ç¬¬4æ¡: ai: "å¥½çš„"
     ç¬¬5æ¡: user: "ç”Ÿæˆä»£ç "
     ...
     ```

     **æƒ…å†µ 1ï¼šå¦‚æœ maxCount = 3ï¼ŒæŸ¥è¯¢ 3 æ¡è®°å½•**ï¼š

     ```
     æŸ¥è¯¢ç»“æœï¼ˆå€’åºï¼Œä»æ–°åˆ°æ—§ï¼‰ï¼š
     - ç¬¬2æ¡: tool_result
     - ç¬¬3æ¡: tool_request
     - ç¬¬4æ¡: ai

     é—®é¢˜ï¼š
     - tool_result åœ¨ tool_request å‰é¢ï¼
     - ä½†æ­£ç¡®çš„é¡ºåºåº”è¯¥æ˜¯ï¼štool_request â†’ tool_result
     - è¿™ä¸ªé¡ºåºé”™è¯¯ä¼šå¯¼è‡´ API æŠ¥é”™
     ```

     **æƒ…å†µ 2ï¼šå¦‚æœ maxCount = 2ï¼ŒæŸ¥è¯¢ 2 æ¡è®°å½•**ï¼š

     ```
     æŸ¥è¯¢ç»“æœï¼ˆå€’åºï¼Œä»æ–°åˆ°æ—§ï¼‰ï¼š
     - ç¬¬2æ¡: tool_result
     - ç¬¬3æ¡: tool_request

     é—®é¢˜ï¼š
     - tool_result åœ¨ tool_request å‰é¢ï¼Œé¡ºåºé”™è¯¯ï¼
     - è€Œä¸”æŸ¥è¯¢ç»“æœä¸­åªæœ‰ tool_result å’Œ tool_requestï¼Œä½†é¡ºåºæ˜¯åçš„
     ```

     **è§£å†³æ–¹æ¡ˆï¼šè°ƒæ•´ maxCount = 1ï¼Œé‡æ–°æŸ¥è¯¢**ï¼š

     ```
     æŸ¥è¯¢ç»“æœï¼ˆå€’åºï¼Œä»æ–°åˆ°æ—§ï¼‰ï¼š
     - ç¬¬3æ¡: tool_request

     ç»“æœï¼š
     - æ²¡æœ‰ tool_resultï¼Œé¿å…äº†é¡ºåºé—®é¢˜
     - æˆ–è€…å¯ä»¥æŸ¥è¯¢æ›´å¤šè®°å½•ï¼Œç¡®ä¿ tool_request å’Œ tool_result éƒ½åœ¨æŸ¥è¯¢èŒƒå›´å†…
     ```

     **å…³é”®ç†è§£**ï¼š

     - å› ä¸ºæŸ¥è¯¢æ˜¯**å€’åº**çš„ï¼Œæ‰€ä»¥ `tool_result`ï¼ˆæ›´æ–°çš„è®°å½•ï¼‰ä¼šå‡ºç°åœ¨ `tool_request`ï¼ˆæ›´æ—©çš„è®°å½•ï¼‰å‰é¢
     - å¦‚æœæŸ¥è¯¢è¾¹ç•Œæ­£å¥½åœ¨ `tool_result` è¿™é‡Œï¼Œå°±ä¼šå‡ºç°é¡ºåºé—®é¢˜
     - é€šè¿‡ç¼©å°æŸ¥è¯¢èŒƒå›´ï¼Œå¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜

  5. **è°ƒæ•´ç­–ç•¥**ï¼ˆé‡è¦ï¼šä¸ä¼šæ— é™ç¼©å°ï¼ï¼‰ï¼š

     - å°† `maxCount` å‡ 1ï¼Œé‡æ–°è®¡ç®— `actualLimit`
     - **åªè°ƒæ•´ä¸€æ¬¡**ï¼Œä¸ä¼šæ— é™å¾ªç¯ç¼©å°
     - é‡æ–°æŸ¥è¯¢ï¼Œä½¿ç”¨æ›´å°çš„æŸ¥è¯¢èŒƒå›´
     - å¦‚æœè°ƒæ•´å `maxCount = 0`ï¼Œè¯´æ˜æ— æ³•ä¿è¯å®Œæ•´æ€§ï¼Œç›´æ¥è¿”å›ç©ºåˆ—è¡¨
     - å¦‚æœé‡æ–°æŸ¥è¯¢åè¿˜æ˜¯æœ‰é—®é¢˜ï¼Œå°±è¿”å›ç»“æœï¼ˆä¸ä¼šå†æ¬¡è°ƒæ•´ï¼‰

     **ä¸ºä»€ä¹ˆä¸ä¼šæ— é™ç¼©å°**ï¼š

     - ä»£ç ä¸­åªæ‰§è¡Œä¸€æ¬¡è°ƒæ•´ï¼ˆ`maxCount - 1`ï¼‰
     - è°ƒæ•´åé‡æ–°æŸ¥è¯¢ï¼Œæ— è®ºç»“æœå¦‚ä½•ï¼Œéƒ½ä¼šè¿”å›
     - ä¸ä¼šå†æ¬¡æ£€æŸ¥è¾¹ç•Œæˆ–å†æ¬¡è°ƒæ•´
     - è¿™æ ·å¯ä»¥åœ¨ä¿è¯å·¥å…·è°ƒç”¨å®Œæ•´æ€§çš„åŒæ—¶ï¼Œå°½å¯èƒ½åŠ è½½æ›´å¤šçš„å†å²è®°å½•
     - å¦‚æœè°ƒæ•´åè¿˜æ˜¯æœ‰é—®é¢˜ï¼Œè‡³å°‘è¿”å›çš„æ•°æ®æ¯”åŸæ¥å°‘ï¼Œä½†ä¸ä¼šå¯¼è‡´æ— é™å¾ªç¯

  **æ€»ç»“**ï¼š

  - è¿™ä¸ªè°ƒæ•´æ˜¯ä¸ºäº†**é¿å…åŠ è½½å­¤ç«‹çš„ tool_result**ï¼ˆå‰é¢æ²¡æœ‰å¯¹åº”çš„ tool_requestï¼‰
  - é€šè¿‡ç¼©å°æŸ¥è¯¢èŒƒå›´ï¼Œç¡®ä¿æŸ¥è¯¢ç»“æœçš„æœ€åä¸€æ¡ä¸æ˜¯å­¤ç«‹çš„ `tool_result`
  - å®å¯å°‘åŠ è½½ä¸€äº›å†å²è®°å½•ï¼Œä¹Ÿè¦ä¿è¯å·¥å…·è°ƒç”¨çš„å®Œæ•´æ€§ï¼Œé¿å… API æŠ¥é”™

  **å…³é”®ç†è§£ç‚¹**ï¼š

  - è™½ç„¶å·²ç»æŸ¥è¯¢åˆ°äº†å†å²è®°å½•ï¼Œä½†**æŸ¥è¯¢ç»“æœå¯èƒ½ä¸å®Œæ•´**ï¼ˆç¼ºå°‘ tool_requestï¼‰
  - å¦‚æœç›´æ¥ä½¿ç”¨è¿™ä¸ªä¸å®Œæ•´çš„æŸ¥è¯¢ç»“æœï¼Œä¼šå¯¼è‡´ API æŠ¥é”™
  - å› æ­¤éœ€è¦**ç¼©å°æŸ¥è¯¢èŒƒå›´ï¼Œé‡æ–°æŸ¥è¯¢**ï¼Œç¡®ä¿è¿”å›çš„è®°å½•æ˜¯å®Œæ•´çš„
  - è¿™æ˜¯ä¸€ä¸ª**é˜²å¾¡æ€§ç¼–ç¨‹**çš„ç­–ç•¥ï¼šå®å¯å°‘åŠ è½½ï¼Œä¹Ÿä¸èƒ½åŠ è½½ä¸å®Œæ•´çš„æ•°æ®

#### å®Œæ•´æµç¨‹å›¾

```
å¼€å§‹æŸ¥è¯¢å†å²è®°å½•
    â†“
æ£€æŸ¥æ€»è®°å½•æ•°
    â†“
è®°å½•æ•° â‰¤ 1ï¼Ÿ â†’ æ˜¯ â†’ è¿”å›ç©ºåˆ—è¡¨ï¼ˆä¸å®Œæ•´çš„å¯¹è¯ï¼Œæ— å‚è€ƒä»·å€¼ï¼‰
    â†“ å¦
è®¡ç®—å¯ç”¨è®°å½•æ•° = æ€»è®°å½•æ•° - 1ï¼ˆè·³è¿‡æœ€æ–°çš„ç”¨æˆ·æ¶ˆæ¯ï¼‰
    â†“
æ€»è®°å½•æ•° â‰¤ maxCount + 1ï¼Ÿ â†’ æ˜¯ â†’ ç›´æ¥æŸ¥è¯¢æ‰€æœ‰å¯ç”¨è®°å½•ï¼ˆä¸éœ€è¦è¾¹ç¼˜æ£€æŸ¥ï¼‰
    â†“ å¦
æŸ¥è¯¢ç¬¬ maxCount + 1 æ¡è®°å½•ï¼ˆè¾¹ç¼˜è®°å½•ï¼‰
    â†“
è¾¹ç¼˜è®°å½•æ˜¯ tool_resultï¼Ÿ â†’ æ˜¯ â†’ needExtraRequest = true
    â†“ å¦                    â†“
needExtraRequest = false    è®¡ç®— actualLimit = min(maxCount + 1, availableCount)
    â†“
è®¡ç®— actualLimit = min(maxCount, availableCount)
    â†“
æŸ¥è¯¢å†å²è®°å½•ï¼ˆè·³è¿‡ç¬¬ 1 æ¡ï¼ŒæŸ¥è¯¢ actualLimit æ¡ï¼‰
    â†“
needExtraRequest && å®é™…è¿”å›æ•° â‰¤ maxCountï¼Ÿ â†’ æ˜¯ â†’ è°ƒæ•´ maxCountï¼Œé‡æ–°æŸ¥è¯¢
    â†“ å¦
è¿”å›æŸ¥è¯¢ç»“æœï¼ˆç¡®ä¿å·¥å…·è°ƒç”¨å®Œæ•´æ€§ï¼‰
```

#### å…³é”®è®¾è®¡ç‚¹æ€»ç»“

1. **ä¸ºä»€ä¹ˆè·³è¿‡ç¬¬ä¸€æ¡è®°å½•**ï¼š

   - ç¬¬ä¸€æ¡è®°å½•æ˜¯ç”¨æˆ·æœ€æ–°å‘é€çš„æ¶ˆæ¯ï¼Œå·²ç»åœ¨å½“å‰å¯¹è¯ä¸­
   - ä¸éœ€è¦ä»å†å²è®°å½•ä¸­é‡å¤åŠ è½½

2. **ä¸ºä»€ä¹ˆä½¿ç”¨ ID å€’åº**ï¼š

   - ä¿è¯æ¶ˆæ¯çš„ä¸¥æ ¼é¡ºåºï¼Œé¿å…å·¥å…·è°ƒç”¨é¡ºåºé”™ä¹±
   - é›ªèŠ±ç®—æ³•ç”Ÿæˆçš„ ID æ˜¯ä¸¥æ ¼é€’å¢çš„ï¼Œæ¯”æ—¶é—´æˆ³æ›´å¯é 

3. **ä¸ºä»€ä¹ˆéœ€è¦è¾¹ç¼˜æ£€æŸ¥**ï¼š

   - ç¡®ä¿å·¥å…·è°ƒç”¨çš„å®Œæ•´æ€§ï¼ˆtool_request å’Œ tool_result å¿…é¡»æˆå¯¹ï¼‰
   - é˜²æ­¢æŸ¥è¯¢è¾¹ç•Œæˆªæ–­å·¥å…·è°ƒç”¨ï¼Œå¯¼è‡´ API æŠ¥é”™

4. **ä¸ºä»€ä¹ˆéœ€è¦è°ƒæ•´ maxCount**ï¼š
   - å½“è¾¹ç¼˜è®°å½•æ˜¯ tool_result ä½†æŸ¥è¯¢ç»“æœä¸­æ²¡æœ‰å¯¹åº”çš„ tool_request æ—¶
   - éœ€è¦ç¼©å°æŸ¥è¯¢èŒƒå›´ï¼Œç¡®ä¿å·¥å…·è°ƒç”¨çš„å®Œæ•´æ€§
   - è¿™æ · AI æ‰èƒ½ç†è§£å®Œæ•´çš„å·¥å…·è°ƒç”¨æµç¨‹

---

## äº”ã€æ¶ˆæ¯ç±»å‹æšä¸¾æ‰©å±•

### 5.1 æ–‡ä»¶: `ChatHistoryMessageTypeEnum.java`

**æ–°å¢æšä¸¾å€¼**:

```java
TOOL_EXECUTION_REQUEST("å·¥å…·è°ƒç”¨", "tool_execution_request"),
TOOL_EXECUTION_RESULT("å·¥å…·æ‰§è¡Œç»“æœ", "tool_execution_result");
```

**ä½œç”¨**: æ”¯æŒåŒºåˆ†å’Œå­˜å‚¨å·¥å…·è°ƒç”¨è¯·æ±‚å’Œæ‰§è¡Œç»“æœ

---

## å…­ã€å…¶ä»–æ–‡ä»¶ä¿®æ”¹

### 6.1 `AppServiceImpl.java`

- æ–°å¢ `ChatHistoryOriginalService` ä¾èµ–
- åœ¨ä¿å­˜ç”¨æˆ·æ¶ˆæ¯æ—¶ï¼ŒåŒæ—¶ä¿å­˜åˆ° `chat_history_original` è¡¨
- åœ¨åˆ é™¤åº”ç”¨æ—¶ï¼ŒåŒæ—¶åˆ é™¤å…³è”çš„å®Œæ•´å¯¹è¯å†å²

### 6.2 `StreamHandlerExecutor.java`

- ä¿®æ”¹ `doExecute()` æ–¹æ³•ç­¾åï¼Œæ–°å¢ `ChatHistoryOriginalService` å‚æ•°
- å°†æœåŠ¡ä¼ é€’ç»™å…·ä½“çš„æµå¤„ç†å™¨

### 6.3 `SimpleTextStreamHandler.java`

- ä¿®æ”¹ `handle()` æ–¹æ³•ç­¾åï¼Œæ–°å¢ `ChatHistoryOriginalService` å‚æ•°
- åœ¨ä¿å­˜ AI å“åº”æ—¶ï¼ŒåŒæ—¶ä¿å­˜åˆ° `chat_history_original` è¡¨

### 6.4 `ToolRequestMessage.java`

- æ–°å¢ `text` å­—æ®µï¼Œç”¨äºå­˜å‚¨å·¥å…·è°ƒç”¨æ—¶çš„ AI å“åº”æ–‡æœ¬

### 6.5 `MyBatisCoderGenerator.java`

- æ›´æ–°ä»£ç ç”Ÿæˆå™¨é…ç½®ï¼ŒåŒ…å« `chat_history_original` è¡¨

---

## ä¸ƒã€è§£å†³çš„é—®é¢˜

### 7.1 æ ¸å¿ƒé—®é¢˜

1. **Redis ç¼“å­˜è¿‡æœŸé—®é¢˜**

   - é—®é¢˜ï¼šRedis ç¼“å­˜è¿‡æœŸåï¼Œç”¨æˆ·å†æ¬¡å¯¹è¯æ—¶æ— æ³•æ¢å¤å®Œæ•´ä¸Šä¸‹æ–‡
   - è§£å†³ï¼šé€šè¿‡ `chat_history_original` è¡¨æŒä¹…åŒ–å­˜å‚¨ï¼Œæ”¯æŒå®Œæ•´æ¢å¤

2. **å·¥å…·è°ƒç”¨ä¿¡æ¯ä¸¢å¤±**

   - é—®é¢˜ï¼šå·¥å…·è°ƒç”¨ä¿¡æ¯æ— æ³•æŒä¹…åŒ–ï¼Œå¯¼è‡´ä¸Šä¸‹æ–‡ä¸å®Œæ•´
   - è§£å†³ï¼šæ–°å¢ä¸“é—¨è¡¨å­˜å‚¨å·¥å…·è°ƒç”¨è¯·æ±‚å’Œç»“æœ

3. **æ— æ•ˆæ¶ˆæ¯å¯¼è‡´ API æŠ¥é”™**
   - é—®é¢˜ï¼šåªæœ‰ç©º `function_call` çš„ AI æ¶ˆæ¯å¯¼è‡´ API æŠ¥é”™
   - è§£å†³ï¼šåœ¨åŠ è½½å†å²è®°å½•æ—¶éªŒè¯å¹¶è¿‡æ»¤æ— æ•ˆæ¶ˆæ¯

### 7.2 ä»£ç è´¨é‡æå‡

- å¢å¼ºå¼‚å¸¸å¤„ç†å’Œå®¹é”™èƒ½åŠ›
- æé«˜ä»£ç å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§
- å¢åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•

---

## å…«ã€å½±å“èŒƒå›´

### 8.1 æ•°æ®åº“

- æ–°å¢ `chat_history_original` è¡¨
- éœ€è¦æ‰§è¡Œ SQL è„šæœ¬åˆ›å»ºè¡¨ç»“æ„

### 8.2 API æ¥å£

- æ–°å¢ `/chatHistoryOriginal/*` ç³»åˆ—æ¥å£
- ä¸å½±å“ç°æœ‰æ¥å£

### 8.3 ä¸šåŠ¡é€»è¾‘

- Vue é¡¹ç›®ç”Ÿæˆï¼šä½¿ç”¨å®Œæ•´å¯¹è¯å†å²ï¼ˆåŒ…å«å·¥å…·è°ƒç”¨ï¼‰
- HTML/å¤šæ–‡ä»¶ç”Ÿæˆï¼šä½¿ç”¨ç®€åŒ–å¯¹è¯å†å²ï¼ˆä»…æ–‡æœ¬ï¼‰
- å‘åå…¼å®¹ï¼šä¸å½±å“ç°æœ‰åŠŸèƒ½

---

## ä¹ã€å¾…ä¼˜åŒ–é¡¹

1. **JsonMessageStreamHandler.java** ä¸­çš„ `processToolExecutionMessage()` æ–¹æ³•å­˜åœ¨ TODO æ³¨é‡Šï¼Œéœ€è¦å®Œå–„å·¥å…·è°ƒç”¨è¯·æ±‚å¯¹è±¡çš„æ„é€ é€»è¾‘

2. ä»£ç ä¸­æœ‰å¤šå¤„ TODO æ³¨é‡Šï¼Œéœ€è¦åç»­å®Œå–„ï¼š
   - `AiCodeGeneratorServiceFactory.java`: "ä¸ºä»€ä¹ˆè¿™é‡Œçš„æ–¹æ³•æ²¡æœ‰è§¦å‘"
   - `JsonMessageStreamHandler.java`: "ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Œmap åœ¨ doOnComplete åæ‰§è¡Œï¼Ÿï¼Ÿï¼Ÿ"
   - `JsonMessageStreamHandler.java`: "é‚£ä¸ºä»€ä¹ˆè¿™é‡Œè¿”å›å€¼ String"
   - `JsonMessageStreamHandler.java`: "AI å“åº”å†…å®¹æš‚æ—¶ç»“æŸï¼Œç½®ç©º aiResponseStringBuilder todoï¼šä¸å¤ªæ‡‚"

---

## åã€æµ‹è¯•å»ºè®®

1. **åŠŸèƒ½æµ‹è¯•**

   - æµ‹è¯• Redis è¿‡æœŸåå¯¹è¯å†å²æ¢å¤
   - æµ‹è¯•å·¥å…·è°ƒç”¨ä¿¡æ¯çš„ä¿å­˜å’ŒåŠ è½½
   - æµ‹è¯•æ— æ•ˆæ¶ˆæ¯çš„è¿‡æ»¤æœºåˆ¶

2. **æ€§èƒ½æµ‹è¯•**

   - æµ‹è¯•æ‰¹é‡ä¿å­˜å·¥å…·è°ƒç”¨ä¿¡æ¯çš„æ€§èƒ½
   - æµ‹è¯•åŠ è½½å¤§é‡å†å²è®°å½•çš„æ€§èƒ½

3. **å…¼å®¹æ€§æµ‹è¯•**
   - æµ‹è¯•ç°æœ‰åŠŸèƒ½æ˜¯å¦å—å½±å“
   - æµ‹è¯•ä¸åŒä»£ç ç”Ÿæˆç±»å‹çš„å†å²åŠ è½½

---

_æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2026-01-08_
